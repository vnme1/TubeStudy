<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TubeStudy - í™˜ê²½ ì„¤ì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap");

      /* study.htmlê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ ì ìš© */
      body {
        font-family: "Roboto", sans-serif;
        background-color: #0f0f0f; /* YouTube Dark Background */
        color: #f1f1f1;
      }
    </style>
  </head>
  <body class="h-screen flex overflow-hidden">
    <aside
      class="w-20 flex flex-col items-center py-6 bg-[#0f0f0f] border-r border-[#272727]"
    >
      <div class="mb-10 text-red-600 text-2xl">
        <i class="fab fa-youtube"></i>
      </div>

      <nav class="space-y-8 flex flex-col items-center w-full">
        <a href="study.html" class="text-white text-xl relative group">
          <i class="fas fa-home"></i>
          <span
            class="absolute left-10 bg-gray-800 px-2 py-1 text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-50"
            >ëŒ€ì‹œë³´ë“œ</span
          >
        </a>
        <a
          href="study.html#stats-section"
          class="text-white hover:text-red-500 transition text-xl relative group"
        >
          <i class="fas fa-chart-pie"></i>
          <span
            class="absolute left-10 bg-gray-800 px-2 py-1 text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-50"
            >í†µê³„</span
          >
        </a>
        <a
          href="study.html#courses-section"
          class="text-white hover:text-red-500 transition text-xl relative group"
        >
          <i class="fas fa-list"></i>
          <span
            class="absolute left-10 bg-gray-800 px-2 py-1 text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-50"
            >ì¬ìƒëª©ë¡</span
          >
        </a>
      </nav>

      <div class="mt-auto">
        <div
          class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs font-bold"
        >
          U
        </div>
      </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
      <header
        class="h-16 flex items-center justify-between px-8 border-b border-[#272727]"
      >
        <h1 class="text-lg font-bold tracking-tight">âš™ï¸ í™˜ê²½ ì„¤ì •</h1>
        <div class="flex items-center gap-4">
          <div
            class="flex items-center gap-2 bg-[#272727] px-3 py-1.5 rounded-full border border-[#3f3f3f]"
          >
            <span class="relative flex h-2 w-2">
              <span
                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"
              ></span>
              <span
                class="relative inline-flex rounded-full h-2 w-2 bg-red-500"
              ></span>
            </span>
            <span class="text-xs font-medium text-gray-300"
              >Extension Connected</span
            >
          </div>
          <a href="study.html" class="text-gray-400 hover:text-white transition">
            <i class="fas fa-home"></i>
          </a>
        </div>
      </header>

      <div class="flex-1 overflow-y-auto p-8">
        <!-- í•™ìŠµ ëª©í‘œ ì„¤ì • -->
        <section class="mb-10 max-w-2xl">
          <h2 class="text-2xl font-bold mb-6 border-b border-[#272727] pb-2">
            ğŸ“š í•™ìŠµ ëª©í‘œ ì„¤ì •
          </h2>

          <div class="bg-[#1f1f1f] p-8 rounded-xl shadow-lg border border-[#272727]">
            <form id="settings-form">
              <div class="mb-6">
                <label for="weekly-goal" class="block text-sm font-medium text-gray-300 mb-3">
                  ì£¼ê°„ í•™ìŠµ ëª©í‘œ (ì‹œê°„)
                </label>
                <div class="flex items-center gap-4">
                  <input
                    type="number"
                    id="weekly-goal"
                    name="weeklyGoalHours"
                    min="1"
                    max="168"
                    required
                    class="flex-1 p-3 bg-[#0f0f0f] border border-[#3f3f3f] rounded-lg text-lg text-white placeholder-gray-500 focus:border-red-600 focus:ring-red-600 outline-none"
                    placeholder="ì˜ˆ: 20"
                  />
                  <span class="text-gray-400 font-medium">ì‹œê°„</span>
                </div>
                <p class="mt-2 text-sm text-gray-500">
                  ì¼ì£¼ì¼ì— ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ì´ í•™ìŠµ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”. (1~168ì‹œê°„)
                </p>
              </div>

              <button
                type="submit"
                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-red-800"
              >
                <i class="fas fa-save mr-2"></i> ëª©í‘œ ì €ì¥
              </button>
            </form>

            <div id="message-area" class="mt-4 text-center text-sm" role="alert"></div>
          </div>
        </section>

        <!-- í˜„ì¬ ì§„í–‰ ìƒí™© -->
        <section class="mb-10 max-w-2xl">
          <div class="bg-[#1f1f1f] p-6 rounded-xl border border-[#272727]">
            <h3 class="text-lg font-bold mb-4 text-gray-300">ğŸ“Š ì´ë²ˆ ì£¼ ì§„í–‰ ìƒí™©</h3>
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">í•™ìŠµ ì‹œê°„</span>
                <span id="current-weekly-hours" class="font-bold text-white">00ì‹œê°„ 00ë¶„</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">ì£¼ê°„ ëª©í‘œ</span>
                <span id="goal-weekly-hours" class="font-bold text-white">00ì‹œê°„</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">ë‹¬ì„±ë¥ </span>
                <span id="goal-achievement" class="font-bold text-red-500">0%</span>
              </div>
            </div>
            <div class="w-full bg-gray-700 h-3 rounded-full mt-4 overflow-hidden">
              <div
                id="progress-bar"
                class="h-full bg-gradient-to-r from-red-600 to-orange-500 w-0 transition-all duration-300"
              ></div>
            </div>
          </div>
        </section>

        <!-- ì•Œë¦¼ ì„¤ì • -->
        <section class="mb-10 max-w-2xl">
          <h2 class="text-2xl font-bold mb-6 border-b border-[#272727] pb-2">
            ğŸ”” ì•Œë¦¼ ì„¤ì •
          </h2>

          <div class="bg-[#1f1f1f] p-8 rounded-xl shadow-lg border border-[#272727] space-y-6">
            <!-- ë”´ì§“ ì•Œë¦¼ í™œì„±í™” -->
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-white font-semibold">ë”´ì§“ ë°©ì§€ ì•Œë¦¼</h3>
                <p class="text-sm text-gray-500 mt-1">
                  ë”´ì§“ ì½˜í…ì¸  ê°ì§€ ì‹œ ì•Œë¦¼ì„ ë°›ì„ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
                </p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="distraction-alert"
                  class="sr-only peer"
                  checked
                />
                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
              </label>
            </div>

            <!-- ê³µë¶€ ì™„ë£Œ ì•Œë¦¼ -->
            <div class="flex items-center justify-between pt-4 border-t border-[#3f3f3f]">
              <div>
                <h3 class="text-white font-semibold">ëª©í‘œ ë‹¬ì„± ì•Œë¦¼</h3>
                <p class="text-sm text-gray-500 mt-1">
                  ì£¼ê°„ í•™ìŠµ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ë©´ ì¶•í•˜ ì•Œë¦¼ì„ ë°›ìŠµë‹ˆë‹¤.
                </p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="achievement-alert"
                  class="sr-only peer"
                  checked
                />
                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
              </label>
            </div>
          </div>
        </section>

        <!-- ë°ì´í„° ê´€ë¦¬ -->
        <section class="mb-10 max-w-2xl">
          <h2 class="text-2xl font-bold mb-6 border-b border-[#272727] pb-2">
            ğŸ—‘ï¸ ë°ì´í„° ê´€ë¦¬
          </h2>

          <div class="bg-[#1f1f1f] p-8 rounded-xl shadow-lg border border-[#272727] space-y-4">
            <button
              id="export-button"
              class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200"
            >
              <i class="fas fa-download"></i> í•™ìŠµ ê¸°ë¡ ë‚´ë³´ë‚´ê¸° (CSV)
            </button>

            <button
              id="clear-button"
              class="w-full flex items-center justify-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transition duration-200"
            >
              <i class="fas fa-trash-alt"></i> ëª¨ë“  ê¸°ë¡ ì‚­ì œ
            </button>
          </div>
        </section>

        <!-- ë²„ì „ ì •ë³´ -->
        <section class="max-w-2xl">
          <div class="bg-[#1f1f1f] p-6 rounded-xl border border-[#272727] text-center text-gray-500 text-sm">
            <p><i class="fas fa-info-circle"></i> TubeStudy v1.0.0 Â· 2025</p>
            <p class="mt-2">ëª¨ë“  í•™ìŠµ ë°ì´í„°ëŠ” ë¡œì»¬ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
          </div>
        </section>
      </div>
    </main>

    <script>
      // í¬íŠ¸ ë²ˆí˜¸ 18085ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
      const SETTINGS_API_URL = 'http://localhost:18085/api/settings';
      const STATS_API_URL = 'http://localhost:18085/api/tracker/dashboard/stats';

      const goalInput = document.getElementById('weekly-goal');
      const settingsForm = document.getElementById('settings-form');
      const messageArea = document.getElementById('message-area');
      const distractionAlert = document.getElementById('distraction-alert');
      const achievementAlert = document.getElementById('achievement-alert');
      const exportButton = document.getElementById('export-button');
      const clearButton = document.getElementById('clear-button');

      // ë©”ì‹œì§€ í‘œì‹œ í—¬í¼ í•¨ìˆ˜
      function showMessage(text, isSuccess = true) {
        messageArea.innerText = text;
        messageArea.className = `mt-4 text-center text-sm font-medium ${isSuccess ? 'text-green-500' : 'text-red-500'}`;

        setTimeout(() => {
          messageArea.innerText = '';
        }, 3000);
      }

      // ì‹œê°„ì„ ì‹œ:ë¶„ í˜•ì‹ìœ¼ë¡œ í¬ë§·í•˜ëŠ” í•¨ìˆ˜
      function formatMinutesToTime(totalMinutes) {
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${hours}ì‹œê°„ ${minutes}ë¶„`;
      }

      // =========================================================
      // 1. í˜„ì¬ ì„¤ì • ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
      // =========================================================
      async function fetchCurrentSettings() {
        try {
          const response = await fetch(SETTINGS_API_URL);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();
          goalInput.value = data.weeklyGoalHours;

          // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì•Œë¦¼ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
          const distractionAlertSetting = localStorage.getItem('distractionAlert');
          const achievementAlertSetting = localStorage.getItem('achievementAlert');
          
          if (distractionAlertSetting !== null) {
            distractionAlert.checked = JSON.parse(distractionAlertSetting);
          }
          if (achievementAlertSetting !== null) {
            achievementAlert.checked = JSON.parse(achievementAlertSetting);
          }
        } catch (error) {
          console.error("ì„¤ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          showMessage("ì„¤ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.", false);
        }
      }

      // =========================================================
      // 2. í˜„ì¬ ì£¼ê°„ ì§„í–‰ ìƒí™© í‘œì‹œ
      // =========================================================
      async function updateWeeklyProgress() {
        try {
          const response = await fetch(`${STATS_API_URL}?periodType=week`);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const stats = await response.json();

          // ì‹œê°„ì„ ë¶„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
          const totalMinutes = Math.floor(stats.totalStudySeconds / 60);
          document.getElementById('current-weekly-hours').innerText = formatMinutesToTime(totalMinutes);
          document.getElementById('goal-weekly-hours').innerText = `${goalInput.value}ì‹œê°„`;

          const achievement = Math.round(stats.weekGoalPercentage);
          document.getElementById('goal-achievement').innerText = `${achievement}%`;
          document.getElementById('progress-bar').style.width = `${Math.min(100, achievement)}%`;
        } catch (error) {
          console.error("ì£¼ê°„ ì§„í–‰ ìƒí™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
      }

      // =========================================================
      // 3. ì„¤ì • ê°’ ì €ì¥ (í¼ ì œì¶œ)
      // =========================================================
      settingsForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        const weeklyGoalHours = parseInt(goalInput.value, 10);

        if (isNaN(weeklyGoalHours) || weeklyGoalHours < 1 || weeklyGoalHours > 168) {
          showMessage("ìœ íš¨í•œ ì£¼ê°„ ëª©í‘œ ì‹œê°„(1~168)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", false);
          return;
        }

        try {
          const response = await fetch(SETTINGS_API_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ weeklyGoalHours: weeklyGoalHours })
          });

          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const updatedData = await response.json();

          showMessage(`âœ… ëª©í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: ${updatedData.weeklyGoalHours}ì‹œê°„`, true);
          
          // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
          updateWeeklyProgress();
        } catch (error) {
          console.error("ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          showMessage("âŒ ëª©í‘œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.", false);
        }
      });

      // =========================================================
      // 4. ì•Œë¦¼ ì„¤ì • ì €ì¥ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€)
      // =========================================================
      distractionAlert.addEventListener('change', function() {
        localStorage.setItem('distractionAlert', JSON.stringify(this.checked));
      });

      achievementAlert.addEventListener('change', function() {
        localStorage.setItem('achievementAlert', JSON.stringify(this.checked));
      });

      // =========================================================
      // 5. ë°ì´í„° ë‚´ë³´ë‚´ê¸° (CSV)
      // =========================================================
      exportButton.addEventListener('click', async function() {
        try {
          alert('ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ë‹¤ìŒ ì—…ë°ì´íŠ¸ì—ì„œ ì¶”ê°€ë©ë‹ˆë‹¤.');
          // TODO: ì„œë²„ì—ì„œ CSV ë°ì´í„° ë°›ì•„ ë‹¤ìš´ë¡œë“œ
        } catch (error) {
          console.error("ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          showMessage("âŒ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", false);
        }
      });

      // =========================================================
      // 6. ëª¨ë“  ë°ì´í„° ì‚­ì œ
      // =========================================================
      clearButton.addEventListener('click', function() {
        if (confirm('âš ï¸ ì •ë§ë¡œ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)')) {
          alert('ğŸ—‘ï¸ ì „ì²´ ë°ì´í„° ì‚­ì œ ê¸°ëŠ¥ì€ ë‹¤ìŒ ì—…ë°ì´íŠ¸ì—ì„œ ì¶”ê°€ë©ë‹ˆë‹¤.');
          // TODO: ì„œë²„ì— ì „ì²´ ì‚­ì œ ìš”ì²­
        }
      });

      // =========================================================
      // 7. í˜ì´ì§€ ë¡œë“œ ì‹œ í˜¸ì¶œ
      // =========================================================
      fetchCurrentSettings();
      updateWeeklyProgress();

      // 10ì´ˆë§ˆë‹¤ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë™ê¸°í™”)
      setInterval(updateWeeklyProgress, 10000);
    </script>
  </body>
</html>